#!/bin/sh

[ $(command -v ffmpeg) ] || exit 1
vid=$1
start_time=00:00:01
duration=20
height=ih/2      # input height halved , can replace with pixils .
width=-2         # keeps aspect ratio . can replace with pixils .
fps=25           # frames per a second .

filters="fps=$fps,scale=$width:$height:flags=lanczos"

# ffmpeg \
#   -hide_banner -loglevel error \
#   -i "$vid" \
#   -filter_complex "[0:v] fps=25,scale=w=-2:h=ih/2,split [a][b];[a] palettegen=stats_mode=single [p];[b][p] paletteuse=new=1" \
#   -y "$vid".gif

ffmpeg -i "$1" -vf palettegen -f image2 -c:v png - |
ffmpeg -i "$1" -i - -filter_complex paletteuse test.gif

# ffmpeg -ss $start_time                             \
#        -t  $duration                               \
#        -i  "$vid"                                  \
#        -vf "$filters,palettegen"                   \
#        -y  palette.png                             \
#        && ffmpeg \
#                  -i  "$vid"                                  \
#                  -i  palette.png                             \
#                  -lavfi "$filters [x]; [x][1:v] paletteuse"  \
#                  -y  "$vid".gif                              \
#                              && rm palette.png

[ $(command -v gifsicle) ] || exit 0
# gifsicle -O3 --lossy=35 -o "$vid"-opz.gif "$vid".gif
gifsicle -O3 -o "$vid"-opz.gif "$vid".gif
